/**
 * angular-user-service
 * @version v0.0.6 - 2015-03-05
 * @link https://github.com/aronvaughan/angular-user-service
 * @author  <>
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
"use strict";angular.module("avaughan.user",["avaughan.logging","avaughan.login"]),angular.module("avaughan.user").provider("avUserService",function(){this.mockData=[{"class":"security.User",id:1,accountExpired:!1,accountLocked:!1,email:"aronvaughan@hotmail.com",enabled:!0,password:"8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918",passwordExpired:!1,username:"mock admin"}],this.urlAfterLogin="/",this.userResourceUrl="api/userInfo/current",this.userNameVariable="username",this.userRolesVariable="roles",this.loginEventDoesNotContainFullUserInfo=!1;var a=this;this.paramInitialize=function(a){console.log("avaughan.user param initialize called",[a]),a.mockData&&(this.mockData=a.mockData),a.urlAfterLogin&&(this.urlAfterLogin=a.urlAfterLogin),a.userResourceUrl&&(this.userResourceUrl=a.userResourceUrl),a.userNameVariable&&(this.userNameVariable=a.userNameVariable),a.loginEventDoesNotContainFullUserInfo&&(this.loginEventDoesNotContainFullUserInfo=a.loginEventDoesNotContainFullUserInfo),a.userRolesVariable&&(this.userRolesVariable=a.userRolesVariable)},this.initialize=function(a,b,c,d){console.log("avaughan.user initialize called",[a,c,d]),d&&(this.mockData=d),c&&(this.urlAfterLogin=c),a&&(this.userResourceUrl=a),b&&(this.userNameVariable=b)},this.$get=["$rootScope","$resource","avLog","$location","avLogin","$cookieStore","$http",function(b,c,d,e,f,g,h){var i=this.userResourceUrl,j=new ServiceContainerConfig("avUserService",i,this.mockData,b,c,d);return j.urlAfterLogin=this.urlAfterLogin,j.$location=e,j.avLogin=f,j.eventChannel="AVUSERSERVICE",j.mockExtend={fetchUser:function(){return this.logger.debug("mock user service, fetch user"),this.mockData[0]},login:function(a,b){return this.logger.debug("in mock mode, login",[a,b]),a===this.mockData[0].username?(this.logger.info("redirecting to "+this.urlAfterLogin),this.$location.path(this.urlAfterLogin),this.mockData[0]):void 0},logout:function(){}},j.realExtend={fetchUser:function(){this.logger.debug("user service, fetch user"),this.logger.debug("getting user data from remote");var c=this,d=this.user;return this.user=this.resource.get({},function(e,h){c.logger.debug("userData, fetchUser success callback: ",[e,a.userNameVariable,e[a.userNameVariable],h,d,f.isTokenAvailable(b,g)]),void 0!==e&&void 0!==e[a.userNameVariable]&&void 0===d&&f.isTokenAvailable(b,g)&&(c.logger.info("detected inital load with user token available"),f.loginConfirmed(e)),void 0!==e&&(c.logger.debug("sending event: get success SERVICE."+c.eventChannel+".GET.SUCESS",[e,h]),c.$rootScope.$broadcast("SERVICE."+c.eventChannel+".GET.SUCCESS",e))}),this.logger.debug("got user",this.user),this.user},login:function(a,c){return this.logger.debug("login called",a),this.avLogin.login(a,c,h,b,g,e)},logout:function(){this.avLogin.logout(h,g,b)}},j.serviceExtend={checkedServer:!1,user:void 0,defaultUsername:"Guest",userNameVariable:this.userNameVariable,toLogin:function(a){this.avLogin.toLogin(a)},isLoggedIn:function(){return this.logger.debug("userService isLoggedIn ",this.getUser()),void 0!==this.getUser()&&void 0!==this.getUser()[a.userNameVariable]},getUser:function(){return this.logger.debug("user service, getUser",this.user),void 0===this.user&&(this.logger.debug("user service, getUser needs to fetch"),this.fetchUser()),this.user},getSecurityRoles:function(){if(this.logger.debug("user service, get security roles called"),this.isLoggedIn()){var b=this.getUser();return this.logger.debug("user service, get security roles, returning ",[b,a.userRolesVariable,b[a.userRolesVariable]]),b[a.userRolesVariable]}return this.logger.debug("not logged in, return blank roles"),[]},hasSecurityRoles:function(a){var b,c=!1,d=!1;return this.isLoggedIn()?this.isLoggedIn()&&void 0===a?c=!0:this.isLoggedIn()&&void 0!==a&&(0===a.length?c=!0:(b=[],angular.forEach(this.getSecurityRoles(),function(a){b.push(a.toLowerCase())}),angular.forEach(a,function(a){d=d||_.contains(b,a.toLowerCase())}),c=d)):c=!1,c},getUsername:function(){return this.logger.debug("getUsername ",[this.user,this.userNameVariable]),this.getUser(),this.user&&this.user[this.userNameVariable]?this.user[this.userNameVariable]:this.defaultUsername},logout:function(){this.logger.debug("userService logout"),this.serviceRemote.logout(),this.resetAfterLogout()},login:function(a,b){return this.serviceRemote.login(a,b)},reset:function(){this.logger.debug("reset called"),this.checkedServer=!1,this.user=void 0},resetAfterLogout:function(){this.reset(),this.checkedServer=!0},setUser:function(a){this.logger.debug("set user",this.user),this.user=a,this.checkedServer=!0,this.logger.debug("set user exit",this.user)},fetchUser:function(){return this.logger.debug("user service, fetch user"),this.checkedServer?this.logger.debug("already checked, not checking again..."):(this.logger.debug("getting user data from user data impl"),this.user=this.serviceRemote.fetchUser(),this.setUser(this.user)),this.user},customInitialize:function(a,c){var d=this;this.logger.info("custom initialize hooking up auth events",[a,c]),this.$rootScope.$on("event:auth-loginConfirmed",function(a,b){d.logger.info("event:auth-loginConfirmed user service got session login event ",a),d.logger.info("user data, does not contain full info",[b,d.loginEventDoesNotContainFullUserInfo]),d.loginEventDoesNotContainFullUserInfo===!0||d.loginEventDoesNotContainFullUserInfo?(d.logger.info("login does not contain full user info, fetching user"),d.checkedServer=!1,d.fetchUser()):(d.logger.info("login does contain full user info, caching"),d.setUser(b))}),b.$on("event:auth-logoutConfirmed",function(a,b){d.logger.info("event:auth-logoutConfirmed",a),d.logger.info("data",b),d.resetAfterLogout()}),b.$on("event:auth-loginRequired",function(a,b){d.logger.info("event:auth-loginRequired! user service got session login event ",a),d.logger.info("data",b)}),b.$on("event:auth-loginCancelled",function(a,b){d.logger.info("event:auth-auth-loginCancelled user service got session login event ",a),d.logger.info(" data",b)})}},j.createService()}]}),angular.module("avaughan.user").directive("visibleToRoles",["avUserService","avLog","$rootScope",function(a,b,c){var d=b.getLogger("visibleToRoles");return{link:function(b,e,f){d.debug("link called",f);var g=function(){d.debug("make visible",e),e.removeClass("ng-hide")},h=function(){d.debug("make hidden",e),e.addClass("ng-hide")},i=function(b){d.debug("determine visibility"),b&&g(),a.hasSecurityRoles(j)?(d.debug("has roles",[a.getSecurityRoles(),j]),g()):(d.debug("does not have roles",[a.getSecurityRoles(),j,e]),h())},j=f.visibleToRoles.split(",");d.debug("roles ",j),c.$on("event:auth-loginConfirmed",function(a,b){d.info("event:auth-loginConfirmed user service got session login event ",[a,b]),i(!0)}),c.$on("event:auth-logoutConfirmed",function(a,b){d.info("event:auth-logoutConfirmed user service got session login event ",[a,b]),i(!0)}),j.length>0&&i(!0)}}}]);